<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Premium Access</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f0f0; }
        .container { background: white; padding: 30px; border-radius: 8px; display: inline-block; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #4285F4; color: white; border: none; border-radius: 4px; }
        #debug { margin-top: 20px; text-align: left; background: #eee; padding: 10px; font-size: 12px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Premium Login</h2>
        <button id="loginBtn" onclick="handleLogin()">Login with Google</button>
        <div id="status" style="margin-top:10px; color: red;"></div>
        
        <!-- DEBUG BOX TO SEE WHAT IS HAPPENING -->
        <div id="debug">Debug: Waiting for action...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB704MhSDHL76EpI5DMFGOo-t5hla_MyrQ",
            authDomain: "alaminedge-5ccea.firebaseapp.com",
            projectId: "alaminedge-5ccea",
            storageBucket: "alaminedge-5ccea.firebasestorage.app",
            messagingSenderId: "769540906766",
            appId: "1:769540906766:web:ec6fb26fa7eb1f4a69815f",
            measurementId: "G-7HEEXR68GX"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const debugDiv = document.getElementById("debug");

        function logDebug(msg) {
            console.log(msg);
            debugDiv.innerHTML += "<br>> " + msg;
        }

        function handleLogin() {
            logDebug("Button clicked. Starting redirect...");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider).catch(error => {
                logDebug("ERROR: " + error.message);
            });
        }

        // 1. HANDLE THE REDIRECT COMING BACK
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                logDebug("User returned from Google: " + result.user.email);
                verifyUser(result.user.email);
            } else {
                logDebug("No redirect result found (Fresh visit).");
            }
        }).catch((error) => {
            logDebug("Redirect Error: " + error.message);
        });

        // 2. LISTEN TO STATE CHANGES
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Only log here if we haven't just handled the redirect (prevents double-checking)
                // But for safety, we check again
                logDebug("Auth State Changed: User is " + user.email);
                // verifyUser(user.email); // Commented out to prevent double-call conflicts
            } else {
                logDebug("Auth State: Signed Out");
            }
        });

        function verifyUser(email) {
            logDebug("Checking Firestore for email: " + email);
            db.collection("allowed_emails").doc(email).get()
                .then((doc) => {
                    if (doc.exists) {
                        logDebug("SUCCESS! Email found. Redirecting...");
                        sessionStorage.setItem("authTicket", email);
                        window.location.href = "secure-zone-test/content.html";
                    } else {
                        logDebug("FAILED. Email not in list.");
                        alert("Access Denied. Email not authorized.");
                        auth.signOut();
                    }
                })
                .catch((error) => {
                    logDebug("Database Error: " + error.message);
                    alert("Error checking database. Check console.");
                });
        }
    </script>
</body>
</html>
